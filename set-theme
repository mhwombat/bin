#! /usr/bin/env nix-shell
#! nix-shell -i bash -p mustache-go yamllint
#: Change colour scheme for supported apps.

BASE24_PALETTE_NAME=${1:-default}        # name of the selected base24 palette
DOTDIR=~/github/dotWombat
THEME_DIR=${DOTDIR}/themes
CONFIG_DIR=${DOTDIR}/.config
HUES_FILE=${THEME_DIR}/hues.yaml         # maps base24 colors to "hues"
ORDER_FILE=${THEME_DIR}/hue-order.yaml   # lists preferred hues, in order of preference
ROLES_FILE=${THEME_DIR}/roles.yaml       # assigns hues to roles
BASE24_DIR=~/github/schemes/base24
BASE24_FILE=${BASE24_DIR}/${BASE24_PALETTE_NAME}.yaml

function rgb-to-bgr {
  sed 's/#\(..\)\(..\)\(..\)/\3\2\1/'
}

function normalise-rgb {
  sed 's/: "#\([^"]*\)"/: "\U\1"/'
}

function run-mustache {
  temp_file=$(mktemp "set-theme_XXXXXX.rm")
  mustache  --allow-missing-variables=false $1 $2 > ${temp_file}
  result=$?
  if [ $result -gt 0 ] ; then
    echo "ERROR processing $1 with template $2" >&2
    cat ${temp_file} >&2
    exit
  else
    cat ${temp_file}
    rm ${temp_file}
  fi
}

#
# Ensure that the base24 palette is available
#
# echo "DEBUG BASE24_FILE=$BASE24_FILE"
if [ -e "$BASE24_FILE" ] ; then
  :
else
  echo "ERROR: Cannot find theme file $BASE24_FILE"
  exit
fi

#
# Assemble all of the configuration settings and format them as needed for the apps
#
RGB_FILE=$(mktemp "set-theme_XXXXXX.rgb")
sed 's/: "#\([^"]*\)"/: "\U\1"/' ${BASE24_FILE} > ${RGB_FILE}

BGR_FILE=$(mktemp "set-theme_XXXXXX.bgr")
sed 's/#\(..\)\(..\)\(..\)/\3\2\1/' ${BASE24_FILE} > ${BGR_FILE}

RGB_CONFIG_FILE=$(mktemp "set-theme_XXXXXX.rgb.config")
cat ${RGB_FILE} ${HUES_FILE} ${ORDER_FILE} ${ROLES_FILE} | recurse-yaml > ${RGB_CONFIG_FILE}
result=$?
if [ $result -gt 0 ] ; then
  echo "ERROR while expanding YAML $result"
fi

BGR_CONFIG_FILE=$(mktemp "set-theme_XXXXXX.bgr.config")
cat ${BGR_FILE} ${HUES_FILE} ${ORDER_FILE} ${ROLES_FILE} | recurse-yaml > ${BGR_CONFIG_FILE}
result=$?
if [ $result -gt 0 ] ; then
  echo "ERROR while expanding YAML $result"
fi

#
# Configure foot
#
FOOT_THEME_DIR=${CONFIG_DIR}/foot
run-mustache ${RGB_CONFIG_FILE} ${FOOT_THEME_DIR}/colours.mustache > ${FOOT_THEME_DIR}/colours.ini

#
# Configure starship
#
STARSHIP_THEME_DIR=${CONFIG_DIR}/starship
run-mustache ${RGB_CONFIG_FILE} ${STARSHIP_THEME_DIR}/starship.toml.mustache > ${STARSHIP_THEME_DIR}/starship.toml

#
# Configure textadept
TEXTADEPT_THEME_DIR=${CONFIG_DIR}/textadept/themes
run-mustache ${BGR_CONFIG_FILE} ${TEXTADEPT_THEME_DIR}/base24.mustache > ${TEXTADEPT_THEME_DIR}/base24.lua

#
# Configure niri
#
NIRI_THEME_DIR=${CONFIG_DIR}/niri
mustache ${RGB_CONFIG_FILE} ${NIRI_THEME_DIR}/colour.kdl.mustache > ${NIRI_THEME_DIR}/colour.kdl

#
# Configure waybar
#
WAYBAR_THEME_DIR=${CONFIG_DIR}/waybar
mustache ${RGB_CONFIG_FILE} ${WAYBAR_THEME_DIR}/style.css.mustache > ${WAYBAR_THEME_DIR}/style.css

#
# Configure fuzzel
#
FUZZEL_THEME_DIR=${CONFIG_DIR}/fuzzel
mustache ${RGB_CONFIG_FILE} ${FUZZEL_THEME_DIR}/colours.ini.mustache > ${FUZZEL_THEME_DIR}/colours.ini

# #
# # Configure sway
# #
# SWAY_THEME_DIR=${CONFIG_DIR}/sway
# mustache ${RGB_CONFIG_FILE} ${SWAY_THEME_DIR}/colours.mustache > ${SWAY_THEME_DIR}/colours

#
# Clean up
#
rm ${RGB_FILE} ${BGR_FILE} ${RGB_CONFIG_FILE} ${BGR_CONFIG_FILE}
